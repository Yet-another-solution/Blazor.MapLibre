name: Build, Test, and Publish Multi-Project Solution

on:
  push:
    branches:
      - "main"
      - "release/*"  # For library publishing
  workflow_dispatch: # Allow manual triggering of the workflow

jobs:
  # Job 1: Build and Test Both Projects
  build:
    name: Build, Test, and Package Library
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      # Step 3: Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # Step 4: Build the Library
      - name: Build Library and Examples
        run: dotnet build src/Community.Blazor.MapLibre/Community.Blazor.MapLibre.csproj --no-restore -c Release /p:ContinuousIntegrationBuild=true

      # Step 5: Build the Test Project
      - name: Build Test Project
        run: dotnet build tests/Community.Blazor.MapLibre.Tests/Community.Blazor.MapLibre.Tests.csproj --no-restore -c Release

      # Step 6: Run Tests
      - name: Run Tests
        run: dotnet test tests/Community.Blazor.MapLibre.Tests/Community.Blazor.MapLibre.Tests.csproj --no-build -c Release --verbosity normal

      # Step 7: Pack the Library for NuGet
      - name: Pack NuGet Library
        if: ((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && startsWith(github.ref_name, 'release'))
        run: dotnet pack src/Community.Blazor.MapLibre/Community.Blazor.MapLibre.csproj -c Release --no-build --output nuget
        # Only pack `Community.Blazor.MapLibre.csproj` for NuGet, not the examples

      # Step 8: Upload NuGet packages as artifact
      - name: Upload NuGet Artifact
        if: ((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && startsWith(github.ref_name, 'release'))
        uses: actions/upload-artifact@v4
        with:
          name: nuget
          path: nuget/

      # Step 9: Build the documentation site
      - name: Publish Blazor Examples
        if: ((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && startsWith(github.ref_name, 'main'))
        run: dotnet build docs/Community.Blazor.MapLibre.Documentation.csproj -c Release -o blazor_build_output

      # Step 10: Upload the documentation site as an artifact
      - name: Upload Blazor Deployment Artifact
        if: ((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && startsWith(github.ref_name, 'main'))
        uses: actions/upload-pages-artifact@v3
        with:
          path: blazor_build_output/dist

  # Job 2: Publish NuGet Package
  publish:
    name: Publish Library to NuGet
    runs-on: ubuntu-latest
    needs: [build]  # Requires the Build job to complete

    if: >
      ((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && startsWith(github.ref_name, 'release'))

    steps:
      # Step 1: Download NuGet package artifact from the Build job
      - name: Download NuGet Artifact
        uses: actions/download-artifact@v4
        with:
          name: nuget
          path: nuget

      # Step 2: Setup .NET in the Publish job
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 10.0.x

      # Step 3: Publish the library to NuGet (using GitHub token or API key)
      - name: Publish to NuGet
        run: dotnet nuget push nuget/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

  # Job 3: Deploy Blazor Examples
  deploy:
    name: Deploy Blazor Examples
    runs-on: ubuntu-latest
    needs: [build]  # Requires the Build job to complete
    
    if: >
      ((github.event_name == 'push' || github.event_name == 'workflow_dispatch') && startsWith(github.ref_name, 'main'))

    permissions:
      pages: write      # Grant GitHub Pages deploy permissions
      id-token: write   # To verify the deployment source

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4